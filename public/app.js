async function loadAgents(){ const res = await fetch('/api/agents'); const arr = await res.json(); const grid = document.getElementById('grid'); grid.innerHTML = ''; const tpl = document.getElementById('card'); arr.forEach(a=>{ const node = tpl.content.cloneNode(true); node.querySelector('.name').textContent = a.name || a.id || a.host; node.querySelector('.status').textContent = a.online ? 'online' : 'offline'; const sel = node.querySelector('.files'); (a.files || []).forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; sel.appendChild(o); }); const msg = node.querySelector('.msg'); node.querySelector('.show').addEventListener('click', async ()=>{ msg.textContent='Sending open...'; const body = { host: a.host, file: sel.value }; try{ const r=await fetch('/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const j=await r.json(); msg.textContent = j.ok? 'Opened' : ('Error: '+(j.error||JSON.stringify(j))); }catch(e){ msg.textContent='Network error: '+e.message; } }); node.querySelector('.update').addEventListener('click', async ()=>{ msg.textContent='Triggering update...'; try{ const r=await fetch('/api/push-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ host: a.host })}); const j=await r.json(); msg.textContent = j.ok? 'Update started' : ('Error: '+(j.error||JSON.stringify(j))); }catch(e){ msg.textContent='Network error: '+e.message; } }); node.querySelector('.selfdestruct').addEventListener('click', async ()=>{ if(!confirm('Confirm self-destruct on this agent?')) return; msg.textContent='Sending self-destruct...'; try{ const r=await fetch('/api/selfdestruct',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ host: a.host })}); const j=await r.json(); msg.textContent = j.ok? 'Self-destruct begun' : ('Error: '+(j.error||JSON.stringify(j))); }catch(e){ msg.textContent='Network error: '+e.message; } }); grid.appendChild(node); }); }
document.getElementById('updateAll').addEventListener('click', async ()=>{ if(!confirm('Trigger update on ALL agents?')) return; await fetch('/api/push-update-all',{method:'POST'}); alert('Update commands sent'); });
document.getElementById('selfdestructAll').addEventListener('click', async ()=>{ if(!confirm('Self-destruct ALL agents?')) return; await fetch('/api/selfdestruct-all',{method:'POST'}); alert('Self-destruct commands sent'); });
loadAgents(); setInterval(loadAgents, 5000);
